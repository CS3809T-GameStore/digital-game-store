<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHub - Ultimate Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #e94560; --dark: #1a1a2e; --card-bg: #16213e; }
        body { background-color: var(--dark); color: #fff; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: rgba(22, 33, 62, 0.98); border-bottom: 1px solid #333; }
        .card { background: var(--card-bg); border: none; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); border: 1px solid var(--primary); }
        .btn-primary { background-color: var(--primary); border: none; }
        .page-section { display: none; padding: 20px 0; }
        .page-section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        .tab-content { border: 1px solid #333; border-top: none; padding: 20px; border-radius: 0 0 10px 10px; }
        .nav-tabs .nav-link.active { background-color: var(--primary); color: white; border: none; }
        .nav-tabs .nav-link { color: #bbb; }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#" onclick="showPage('home')"><i class="fas fa-gamepad"></i> GAMEHUB</a>
        <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="nav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" onclick="showPage('home')" data-lang="home">Home</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('library')" data-lang="library">My Library</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('wishlist')" data-lang="wishlist">Wishlist</a></li>
            </ul>
            <div class="d-flex align-items-center gap-3">
                <!-- Currency & Language -->
                <select class="form-select form-select-sm bg-dark text-white" id="currency" onchange="updateSettings()">
                    <option value="USD">USD ($)</option>
                    <option value="SAR">SAR (ر.س)</option>
                </select>
                <select class="form-select form-select-sm bg-dark text-white" id="language" onchange="updateSettings()">
                    <option value="en">English</option>
                    <option value="ar">العربية</option>
                </select>
                <!-- Cart -->
                <a class="nav-link position-relative" onclick="showPage('cart')" style="cursor: pointer;">
                    <i class="fas fa-shopping-cart fa-lg"></i>
                    <span class="badge bg-danger position-absolute top-0 start-100 translate-middle" id="cart-count">0</span>
                </a>
                <!-- Auth -->
                <button class="btn btn-sm btn-outline-light" id="auth-btn" onclick="showPage('login')">Login</button>
            </div>
        </div>
    </div>
</nav>

<!-- 1. HOME PAGE -->
<div id="home" class="page-section active">
    <div class="container">
        <div class="p-5 mb-4 rounded-3 text-white" style="background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://placehold.co/1200x400/222/e94560?text=Massive+Sale'); background-size: cover;">
            <h1 class="display-4 fw-bold" data-lang="welcome">Welcome to GameHub</h1>
            <p class="fs-5" data-lang="hero_desc">Cheap Games, Instant Delivery.</p>
        </div>

        <!-- Category Filter -->
        <div class="d-flex gap-2 mb-4 overflow-auto pb-2">
            <button class="btn btn-outline-light" onclick="filterGames('all')">All</button>
            <button class="btn btn-outline-light" onclick="filterGames('Action')">Action</button>
            <button class="btn btn-outline-light" onclick="filterGames('FPS')">FPS</button>
            <button class="btn btn-outline-light" onclick="filterGames('RPG')">RPG</button>
            <button class="btn btn-outline-light" onclick="filterGames('Arcade')">Arcade</button>
            <button class="btn btn-outline-light" onclick="filterGames('Cards')">Gift Cards</button>
        </div>

        <div class="row g-4" id="games-container">
            <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
        </div>
    </div>
</div>

<!-- 2. PRODUCT DETAILS PAGE -->
<div id="product-details" class="page-section">
    <div class="container">
        <button class="btn btn-secondary mb-3" onclick="showPage('home')">&larr; Back</button>
        <div class="row">
            <div class="col-md-4">
                <img id="detail-img" class="img-fluid rounded shadow w-100">
            </div>
            <div class="col-md-8">
                <h1 id="detail-title" class="fw-bold"></h1>
                <h3 id="detail-price" class="text-primary"></h3>
                <p id="detail-desc" class="lead text-muted mt-3"></p>
                <div class="my-4">
                    <span id="detail-cat" class="badge bg-info me-2"></span>
                    <span id="detail-date" class="badge bg-secondary me-2"></span>
                    <span id="detail-platform" class="badge bg-warning text-dark"></span>
                </div>
                <button class="btn btn-lg btn-success w-100" id="detail-buy-btn">Add to Cart</button>
            </div>
        </div>
    </div>
</div>

<!-- 3. CART PAGE -->
<div id="cart" class="page-section">
    <div class="container">
        <h2 data-lang="cart">Shopping Cart</h2>
        <div id="cart-items" class="my-4">
             <p class="text-muted">Cart is empty.</p>
        </div>
        <div class="text-end">
            <h4 id="cart-total">Total: $0.00</h4>
            <button class="btn btn-primary mt-2 btn-lg" onclick="showPayment()">Proceed to Payment</button>
        </div>
    </div>
</div>

<!-- 4. PAYMENT PAGE -->
<div id="payment" class="page-section">
    <div class="container col-md-6">
        <div class="card p-4 shadow">
            <h3 class="text-center mb-4">Secure Checkout</h3>
            <form onsubmit="event.preventDefault(); processPayment();">
                <div class="mb-3">
                    <label>Card Number (12 Digits)</label>
                    <input type="text" id="card-num" class="form-control bg-dark text-white" maxlength="12" placeholder="123456789012" required>
                </div>
                <div class="mb-3">
                    <label>Card Holder Name</label>
                    <input type="text" id="card-name" class="form-control bg-dark text-white" minlength="12" maxlength="36" placeholder="John Doe Smith" required>
                </div>
                <div class="row mb-3">
                    <div class="col"><input type="text" class="form-control bg-dark text-white" placeholder="MM/YY" required></div>
                    <div class="col"><input type="text" class="form-control bg-dark text-white" placeholder="CVV (3 digits)" maxlength="3" required></div>
                </div>
                <button class="btn btn-success w-100 py-2 fw-bold">Pay & Receive Keys</button>
            </form>
        </div>
    </div>
</div>

<!-- 5. MY LIBRARY (Split Section) -->
<div id="library" class="page-section">
    <div class="container">
        <h2 class="mb-4" data-lang="library">My Library</h2>
        <ul class="nav nav-tabs border-secondary">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#lib-games">My Games</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#lib-cards">Digital Codes</a></li>
        </ul>
        <div class="tab-content bg-dark">
            <div class="tab-pane fade show active" id="lib-games">
                <div class="row g-3" id="lib-games-list"><p class="text-muted p-3">No games purchased yet.</p></div>
            </div>
            <div class="tab-pane fade" id="lib-cards">
                <div class="row g-3" id="lib-cards-list"><p class="text-muted p-3">No codes purchased yet.</p></div>
            </div>
        </div>
    </div>
</div>

<!-- 6. WISHLIST -->
<div id="wishlist" class="page-section">
    <div class="container">
        <h2 class="mb-4" data-lang="wishlist">My Wishlist</h2>
        <div class="row g-4" id="wishlist-container">
             <p class="text-muted">Wishlist is empty.</p>
        </div>
    </div>
</div>

<!-- 7. ADMIN DASHBOARD -->
<div id="admin" class="page-section">
    <div class="container">
        <h2 class="text-danger mb-4"><i class="fas fa-user-shield"></i> Admin Dashboard</h2>
        <div class="row mb-4">
            <div class="col-md-4"><div class="card p-3 text-center bg-dark border-success"><h3>Revenue</h3><p class="h4 text-success" id="admin-rev">$0</p></div></div>
            <div class="col-md-4"><div class="card p-3 text-center bg-dark border-info"><h3>Users</h3><p class="h4 text-info" id="admin-users">0</p></div></div>
            <div class="col-md-4"><div class="card p-3 text-center bg-dark border-warning"><h3>Orders</h3><p class="h4 text-warning" id="admin-orders">0</p></div></div>
        </div>
        <!-- Add Game Form -->
        <div class="card p-4 mb-4 bg-dark border-secondary">
            <h4><i class="fas fa-plus-circle"></i> Add New Game</h4>
            <div class="row g-2">
                <div class="col-md-6"><input type="text" id="new-title" class="form-control bg-black text-white" placeholder="Game Title"></div>
                <div class="col-md-3"><input type="number" id="new-price" class="form-control bg-black text-white" placeholder="Price (USD)"></div>
                <div class="col-md-3">
                    <select id="new-cat" class="form-select bg-black text-white">
                        <option value="Action">Action</option>
                        <option value="RPG">RPG</option>
                        <option value="FPS">FPS</option>
                        <option value="Cards">Gift Card</option>
                    </select>
                </div>
                <div class="col-12"><input type="text" id="new-img" class="form-control bg-black text-white" placeholder="Image URL"></div>
                <div class="col-12"><textarea id="new-desc" class="form-control bg-black text-white" placeholder="Description"></textarea></div>
                <button class="btn btn-success w-100 mt-2" onclick="adminAddGame()">Save Game</button>
            </div>
        </div>
    </div>
</div>

<!-- 8. LOGIN & REGISTER -->
<div id="login" class="page-section">
    <div class="container col-md-4">
        <div class="card p-4 shadow">
            <h3 class="text-center mb-3">Login</h3>
            <input type="email" id="login-email" class="form-control my-2" placeholder="Email">
            <input type="password" id="login-pass" class="form-control my-2" placeholder="Password">
            <button class="btn btn-primary w-100 my-2" onclick="handleLogin()">Sign In</button>
            <div class="text-center border-top pt-3">
                 <small class="text-muted d-block">Don't have an account?</small>
                 <button class="btn btn-sm btn-outline-secondary mt-1" onclick="alert('Registration is auto-handled on first login for this demo!')">Register</button>
            </div>
            <div class="alert alert-info mt-3 small">
                <strong>Demo Accounts:</strong><br>
                Admin: Admin@gamehub.com / Admin@30<br>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- GLOBAL STATE ---
    let games = [];
    let cart = [];
    let currentUser = null;
    let rate = 1; // USD default
    let symbol = "$";

    const DICT = {
        en: { home: "Home", library: "My Library", wishlist: "Wishlist", cart: "Shopping Cart", welcome: "Welcome to GameHub", hero_desc: "Cheap Games, Instant Delivery." },
        ar: { home: "الرئيسية", library: "مكتبتي", wishlist: "المفضلة", cart: "سلة التسوق", welcome: "مرحباً بك في جيم هب", hero_desc: "ألعاب رخيصة، تسليم فوري." }
    };

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        fetch('/api/products')
            .then(r => r.json())
            .then(data => {
                games = data;
                renderGames(games, 'games-container');
            })
            .catch(e => console.error("Backend not running?", e));
    });

    // --- RENDERING ---
    function renderGames(list, containerId) {
        const div = document.getElementById(containerId);
        div.innerHTML = '';
        if(list.length === 0) { div.innerHTML = '<p class="text-white">No games found.</p>'; return; }
        
        list.forEach(g => {
            let price = (g.priceUsd * rate).toFixed(2);
            div.innerHTML += `
                <div class="col-md-3 col-sm-6">
                    <div class="card h-100">
                        <img src="${g.imageUrl}" class="card-img-top" style="height:180px; object-fit:cover" alt="${g.title}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-truncate">${g.title}</h5>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-secondary">${g.category}</span>
                                <i class="fas fa-heart ${currentUser ? 'text-danger' : 'text-secondary'}" 
                                   style="cursor:pointer" onclick="addToWishlist(${g.id})" title="Add to Wishlist"></i>
                            </div>
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <h5 class="text-warning mb-0">${symbol}${price}</h5>
                                <button class="btn btn-sm btn-primary" onclick="openDetails(${g.id})">View</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
    }

    function openDetails(id) {
        const g = games.find(x => x.id === id);
        if(!g) return;
        document.getElementById('detail-title').innerText = g.title;
        document.getElementById('detail-desc').innerText = g.description;
        document.getElementById('detail-price').innerText = symbol + (g.priceUsd * rate).toFixed(2);
        document.getElementById('detail-img').src = g.imageUrl;
        document.getElementById('detail-cat').innerText = g.category;
        document.getElementById('detail-date').innerText = "Released: " + (g.releaseDate || 'N/A');
        document.getElementById('detail-platform').innerText = g.platform || 'PC';
        
        const btn = document.getElementById('detail-buy-btn');
        btn.innerText = "Add to Cart";
        btn.onclick = () => { 
            cart.push(g); 
            document.getElementById('cart-count').innerText = cart.length; 
            alert("Added to Cart!"); 
        };
        showPage('product-details');
    }

    // --- SETTINGS (Currency/Lang) ---
    function updateSettings() {
        const cur = document.getElementById('currency').value;
        const lang = document.getElementById('language').value;
        
        // Currency
        if(cur === 'SAR') { rate = 3.75; symbol = "SAR "; } else { rate = 1; symbol = "$"; }
        
        // Language
        document.body.dir = (lang === 'ar') ? 'rtl' : 'ltr';
        const texts = DICT[lang];
        document.querySelectorAll('[data-lang]').forEach(el => {
            if(texts[el.dataset.lang]) el.innerText = texts[el.dataset.lang];
        });
        
        // Re-render current views
        renderGames(games, 'games-container'); 
        if(document.getElementById('cart').classList.contains('active')) updateCartUI();
    }

    // --- CART & CHECKOUT ---
    function showPayment() {
        if(cart.length === 0) return alert("Cart is empty!");
        if(!currentUser) return showPage('login');
        showPage('payment');
    }

    function updateCartUI() {
        const container = document.getElementById('cart-items');
        container.innerHTML = '';
        let total = 0;
        if(cart.length === 0) container.innerHTML = '<p class="text-muted">Cart is empty.</p>';
        
        cart.forEach((item, idx) => {
            let price = (item.priceUsd * rate).toFixed(2);
            total += parseFloat(price);
            container.innerHTML += `
                <div class="d-flex justify-content-between align-items-center bg-dark p-3 mb-2 rounded border border-secondary">
                    <div><h5 class="mb-0">${item.title}</h5><small>${item.category}</small></div>
                    <div class="d-flex align-items-center gap-3">
                        <span class="text-warning h5 mb-0">${symbol}${price}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="cart.splice(${idx},1); updateCartUI()">X</button>
                    </div>
                </div>`;
        });
        document.getElementById('cart-total').innerText = `Total: ${symbol}${total.toFixed(2)}`;
        document.getElementById('cart-count').innerText = cart.length;
    }

    function processPayment() {
        const card = document.getElementById('card-num').value;
        const name = document.getElementById('card-name').value;

        if(card.length !== 12 || name.length < 12 || name.length > 36) {
            alert("Invalid Card Details!\n- Card must be exactly 12 digits.\n- Name must be 12-36 characters.");
            return;
        }

        // Parallel Requests
        let promises = cart.map(item => {
            return fetch('/api/checkout', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ productId: item.id, email: currentUser.email, cardNumber: card })
            });
        });

        Promise.all(promises).then(() => {
            alert("Payment Successful!\n\nReceipt sent to: " + currentUser.email + "\nCheck 'My Library' for activation keys.");
            cart = [];
            updateCartUI();
            showPage('library');
        });
    }

    // --- LIBRARY & WISHLIST ---
    function loadLibrary() {
        if(!currentUser) return;
        fetch('/api/my-library?email=' + currentUser.email)
            .then(r => r.json())
            .then(orders => {
                const gamesList = document.getElementById('lib-games-list');
                const cardsList = document.getElementById('lib-cards-list');
                gamesList.innerHTML = ''; cardsList.innerHTML = '';
                
                if(orders.length === 0) {
                    gamesList.innerHTML = '<p class="text-muted p-3">No purchases found.</p>';
                    return;
                }

                orders.forEach(o => {
                    // Determine type simple hack: if name contains "Card" or "Pass" -> Code, else Game
                    const isCard = o.productName.includes("Card") || o.productName.includes("Pass") || o.productName.includes("Plus");
                    const target = isCard ? cardsList : gamesList;
                    
                    target.innerHTML += `
                        <div class="col-12">
                            <div class="card p-3 d-flex flex-row justify-content-between align-items-center bg-black border-secondary">
                                <div>
                                    <h5 class="text-white mb-0">${o.productName}</h5>
                                    <small class="text-muted">Date: ${o.orderDate}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success p-2 mb-1">PAID</span><br>
                                    de class="text-warning user-select-all">${o.transactionId}</code>
                                </div>
                            </div>
                        </div>`;
                });
            });
    }

    function addToWishlist(id) {
        if(!currentUser) return showPage('login');
        fetch('/api/wishlist/add', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ email: currentUser.email, productId: id })
        }).then(r => {
            if(r.ok) alert("Added to Wishlist!");
        });
    }
    
    function loadWishlist() {
        if(!currentUser) return;
        fetch('/api/wishlist?email=' + currentUser.email)
            .then(r => r.json())
            .then(list => {
                renderGames(list, 'wishlist-container');
            });
    }

    // --- ADMIN & AUTH ---
    function handleLogin() {
        const e = document.getElementById('login-email').value;
        const p = document.getElementById('login-pass').value;
        fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ email: e, password: p })
        }).then(r => r.json()).then(data => {
            if(data.error) alert(data.error);
            else {
                currentUser = data;
                document.getElementById('auth-btn').innerText = "Logout";
                document.getElementById('auth-btn').onclick = () => location.reload();
                
                if(data.role === 'ADMIN') {
                    loadAdminStats();
                    showPage('admin');
                } else {
                    showPage('home');
                }
            }
        });
    }

    function loadAdminStats() {
        fetch('/api/admin/sales').then(r => r.json()).then(d => {
            document.getElementById('admin-rev').innerText = symbol + (d.totalRevenue * rate).toFixed(2);
            document.getElementById('admin-users').innerText = d.totalUsers;
            document.getElementById('admin-orders').innerText = d.totalOrders;
        });
    }

    function adminAddGame() {
        const data = {
            title: document.getElementById('new-title').value,
            priceUsd: document.getElementById('new-price').value,
            category: document.getElementById('new-cat').value,
            imageUrl: document.getElementById('new-img').value,
            description: document.getElementById('new-desc').value,
            type: document.getElementById('new-cat').value === 'Cards' ? 'CARD' : 'GAME'
        };
        fetch('/api/admin/product', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(data)
        }).then(r => {
            if(r.ok) { alert("Game Added!"); location.reload(); }
        });
    }

    function filterGames(cat) {
        if(cat === 'all') renderGames(games, 'games-container');
        else renderGames(games.filter(g => g.category.includes(cat)), 'games-container');
    }

    function showPage(id) {
        document.querySelectorAll('.page-section').forEach(x => x.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'library') loadLibrary();
        if(id === 'wishlist') loadWishlist();
        if(id === 'cart') updateCartUI();
    }
</script>
</body>
</html>
